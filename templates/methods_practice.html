{% extends "base.html" %}
{% block title %}VCAA Methods Practice Engine{% endblock %}
{% block head_extra %}
<script src="https://www.desmos.com/api/v1.8/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
<style>
  .methods-container { max-width: 800px; margin: 0 auto; padding: 2rem 1rem; }
  
  /* Dynamic Question Box Sizing */
  .question-card { 
    background: var(--surface); 
    border: 1px solid var(--border); 
    border-radius: var(--radius-xl); 
    padding: 2rem; 
    box-shadow: var(--shadow); 
    margin-bottom: 2rem; 
    min-height: 400px; 
    height: auto; 
    display: flex; 
    flex-direction: column; 
    width: 100%;
    overflow-wrap: break-word;
  }
  
  .question-meta { color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; justify-content: space-between; }
  
  .question-text { 
    font-size: 1.15rem; /* Slightly reduced size */
    font-weight: 500; 
    margin-bottom: 1.5rem; 
    line-height: 1.6; 
    text-align: center; 
    flex: 1; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow-x: auto; /* Handle long equations */
  }

  .input-group { margin-bottom: 1.5rem; }
  .input-group label { display: block; margin-bottom: 0.5rem; color: var(--muted); font-size: 0.9rem; }
  .form-input { width: 100%; padding: 1rem; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; }
  .feedback-card { background: rgba(59,130,246,0.1); border: 1px solid var(--primary); border-radius: var(--radius); padding: 1.5rem; margin-top: 1.5rem; animation: slideIn 0.3s ease-out; }
  .feedback-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
  .mark-badge { background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.9rem; }
  .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 1rem 2rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; transition: transform 0.2s; }
  .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
  .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 1rem 2rem; border-radius: var(--radius); cursor: pointer; width: 100%; margin-top: 1rem; }
  .btn-secondary:hover { background: rgba(255,255,255,0.05); }
  .warning-box { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); color: #fde047; padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem; }
  .mcq-options { display:grid; gap:0.75rem; }
  .mcq-option { display:flex; align-items:center; gap:0.75rem; cursor:pointer; }
  .mcq-option input { position:absolute; opacity:0; pointer-events:none; }
  .mcq-option span {
    flex:1; display:block; padding:0.9rem 1rem; border:1px solid var(--border);
    border-radius: var(--radius); background:#121a2b; color: var(--text); transition: all 0.15s ease; text-align:left;
  }
  .mcq-option:hover span { border-color: var(--primary); }
  .mcq-option input:checked + span {
    background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-color: transparent;
  }
  .quiz-status { font-size: 0.9rem; color: var(--muted); padding: 0.5rem 1rem; background: rgba(255,255,255,0.05); border-radius: 999px; border: 1px solid var(--border); margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }

  /* Exit Button & Modal */
  .btn-exit {
    background: transparent; color: #ef4444; border: 1px solid #ef4444;
    padding: 0.5rem 1rem; border-radius: var(--radius);
    font-size: 0.85rem; font-weight: 600; cursor: pointer;
    transition: all 0.2s; text-decoration: none; display: inline-block;
  }
  .btn-exit:hover { background: rgba(239, 68, 68, 0.1); }
  
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
    backdrop-filter: blur(2px);
  }
  .modal-overlay.active { opacity: 1; pointer-events: auto; }
  .modal-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-xl); padding: 2rem;
    max-width: 400px; width: 90%;
    text-align: center; box-shadow: var(--shadow);
    transform: scale(0.95); transition: transform 0.2s;
  }
  .modal-overlay.active .modal-box { transform: scale(1); }
  .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; }

  /* Answer Feedback */
  .answer-correct { border: 1px solid #22c55e !important; background: rgba(34,197,94,0.1) !important; }
  .answer-incorrect { border: 1px solid #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; }
  .answer-correct h3 { color: #4ade80 !important; }
  .answer-incorrect h3 { color: #fca5a5 !important; }
  .answer-correct .mark-badge { background: #22c55e !important; color: white !important; }
  .answer-incorrect .mark-badge { background: #ef4444 !important; color: white !important; }
</style>
{% endblock %}

{% block top_actions %}
{% if session.methods_exam_type == 'tech_active' %}
<button id="calc-toggle-btn" class="btn-exit" style="margin-right: 0.5rem; color: var(--primary); border-color: var(--primary);">üßÆ Open Graphing Calculator</button>
{% endif %}
<button id="btn-exit-trigger" class="btn-exit">Exit Quiz</button>
{% endblock %}

{% block content %}
<main class="methods-container">
  
  {% if quiz_complete %}
  <div class="question-card" style="text-align: center;">
    <h2>üéâ Quiz Complete!</h2>
    <p style="font-size: 1.2rem; color: var(--muted); margin: 1.5rem 0;">You scored</p>
    <div style="font-size: 3rem; font-weight: bold; color: var(--primary); margin-bottom: 1.5rem;">
      {{ score }} / {{ total }}
    </div>
    <div style="display: flex; gap: 1rem; justify-content: center;">
      <a href="{{ url_for('methods_setup') }}" class="btn-primary" style="text-decoration: none; display: inline-block;">Start New Quiz</a>
      <a href="{{ url_for('index') }}" class="btn-secondary" style="text-decoration: none; display: inline-block; width: auto;">Home</a>
    </div>
  </div>
  {% else %}

  <div class="quiz-status">
    <span><strong>Topic:</strong> {{ session.methods_topic }}</span>
    <span><strong>Progress:</strong> Question {{ current_index }} of {{ total_questions }}</span>
    <span>
      <strong>Mode:</strong> 
      {% if timed_on %}
        Timed (1.5 min/mark)
      {% else %}
        Untimed
      {% endif %}
    </span>
  </div>

  {% if session.methods_exam_type == 'tech_active' %}
  <div id="graphing-calc" style="width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 5px; display: none; margin-bottom: 2rem;"></div>
  {% endif %}

  <div class="question-card">
    <div class="question-meta">
      <span>Question {{ question.id }}</span>
      <span>{{ "SHORT ANSWER" if question.type|lower == 'short' else "MULTIPLE CHOICE" }}</span>
      <span>{{ question.marks }} Marks</span>
    </div>

    {% if timed_on %}
    <div id="timer" style="margin-bottom: 1rem; color:#e2e8f0; text-align: center;">
      ‚è± Time remaining: <strong><span id="time-left">{{ time_remaining }}</span></strong>
    </div>
    {% endif %}

    <div class="question-text">{{ question.text | safe }}</div>

    {% if feedback %}
    <div class="feedback-card {% if feedback.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
      <div class="feedback-header">
        <h3 style="margin:0;">{% if feedback.is_correct %}Correct!{% else %}Assessment{% endif %}</h3>
        <span class="mark-badge">{{ feedback.mark }} / {{ feedback.max_marks }}</span>
      </div>
      <p style="margin:0; line-height: 1.6;">{{ feedback.feedback | safe }}</p>
    </div>
    {% endif %}

    {% if not feedback or not feedback.is_correct %}
    <form id="methods-form" method="POST" action="/methods-practice" style="margin-top: auto;">
      <input type="hidden" name="time_expired" id="time-expired" value="0" />
      {% if speed_warning %}
      <div class="warning-box">
        <strong>‚ö°Ô∏è Whoa there!</strong> You answered that very quickly (< 3s).<br>
        To ensure valid practice, please briefly explain your working out below.
      </div>
      <div class="input-group">
        <label>Working / Reasoning</label>
        <textarea name="working" class="form-input" rows="3" placeholder="e.g. Used chain rule..." required></textarea>
      </div>
      {% endif %}

      {% if question.type|lower == 'mcq' %}
      <div class="input-group">
        <label>Choose your answer</label>
        <div class="mcq-options">
          {% for key, val in question.options.items() %}
          <label class="mcq-option">
            <input type="radio" name="choice" value="{{ key }}" required />
            <span><strong>{{ key }}.</strong> {{ val | safe }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="input-group">
        <label>Your Answer</label>
        <input type="text" name="answer" class="form-input" value="{{ user_answer or '' }}" placeholder="Enter your final answer..." required autocomplete="off">
      </div>
      {% endif %}

      <button type="submit" class="btn-primary">Submit Answer</button>
    </form>
    {% endif %}

    {% if feedback %}
      <div style="margin-top: 2rem;">
        {% if feedback.is_correct or attempts >= 3 %}
          <a href="{{ url_for('methods_practice', action='next') }}"><button class="btn-primary">Next Question ‚Üí</button></a>
        {% elif show_try_again %}
          <button type="button" id="tryAgainBtn" class="btn-secondary">Try Again</button>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Exit Modal -->
  <div id="exit-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="margin-bottom: 0.5rem; color: var(--text);">Exit Quiz?</h3>
      <p style="color: var(--muted); margin-bottom: 1.5rem;">Are you sure? Exiting will reset your progress for this quiz.</p>
      <div class="modal-actions">
        <button id="btn-modal-cancel" class="btn-secondary" style="margin-top:0; width:auto; padding:0.5rem 1.5rem;">Cancel</button>
        <a href="{{ url_for('methods_exit') }}" class="btn-primary" style="text-decoration:none; width:auto; padding:0.5rem 1.5rem; background: #ef4444; border:none; display: inline-block; line-height: 1.5;">Exit</a>
      </div>
    </div>
  </div>
  {% endif %}

</main>
{% endblock %}
{% block scripts %}
<script>
  // Timer Logic
  const timeLeftEl = document.getElementById('time-left');
  const formEl = document.getElementById('methods-form');
  const expiredEl = document.getElementById('time-expired');
  if (timeLeftEl && formEl && expiredEl) {
    function formatTime(totalSeconds) {
      const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const s = (totalSeconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }
    let remaining = parseInt(timeLeftEl.textContent || '0', 10);
    timeLeftEl.textContent = formatTime(remaining);
    const tick = () => {
      remaining = Math.max(0, remaining - 1);
      timeLeftEl.textContent = formatTime(remaining);
      if (remaining <= 0) { expiredEl.value = '1'; formEl.submit(); } else { setTimeout(tick, 1000); }
    };
    setTimeout(tick, 1000);
  }

  // MathJax
  if (window.MathJax && window.MathJax.typeset) { window.MathJax.typeset(); }

  // Modal Logic
  const exitBtn = document.getElementById('btn-exit-trigger');
  const modal = document.getElementById('exit-modal');
  const cancelBtn = document.getElementById('btn-modal-cancel');
  
  if (exitBtn && modal && cancelBtn) {
    exitBtn.addEventListener('click', (e) => {
      e.preventDefault();
      modal.classList.add('active');
    });
    cancelBtn.addEventListener('click', () => {
      modal.classList.remove('active');
    });
    // Close on click outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
      }
    });
  }

  // Calculator Logic
  const calcToggleBtn = document.getElementById('calc-toggle-btn');
  if (calcToggleBtn) {
    calcToggleBtn.addEventListener('click', function() { 
        const container = document.getElementById('graphing-calc'); 
        if (container.style.display === 'none') { 
            container.style.display = 'block'; 
            if (!window.desmosCalculator) { 
                window.desmosCalculator = Desmos.GraphingCalculator(container, { 
                    keypad: true, 
                    expressions: true, 
                    lockViewport: false 
                }); 
            } 
            this.textContent = 'Close Graphing Calculator';
        } else { 
            container.style.display = 'none'; 
            this.textContent = 'üßÆ Open Graphing Calculator';
        } 
    }); 
  }

  // Try Again Logic
  const tryAgainBtn = document.getElementById('tryAgainBtn');
  if (tryAgainBtn) {
    tryAgainBtn.onclick = function() {
      // Hide feedback card
      const feedbackCard = document.querySelector('.feedback-card');
      if (feedbackCard) feedbackCard.style.display = 'none';
      
      // Hide the Try Again button itself
      tryAgainBtn.closest('div').style.display = 'none';

      // Clear inputs
      const textInput = document.querySelector('input[name="answer"]');
      if (textInput) {
        textInput.value = '';
        textInput.focus();
      }
      
      const radioInputs = document.querySelectorAll('input[name="choice"]');
      radioInputs.forEach(r => r.checked = false);

      // If there was a working/reasoning box (speed warning), ideally clear it too
      const working = document.querySelector('textarea[name="working"]');
      if (working) working.value = '';
    };
  }
</script>
{% endblock %}
