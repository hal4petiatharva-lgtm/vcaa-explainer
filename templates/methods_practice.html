{% extends "base.html" %}
{% block title %}VCAA Methods Practice Engine{% endblock %}
{% block head_extra %}
<style>
  .methods-container { max-width: 800px; margin: 0 auto; padding: 2rem 1rem; }
  .question-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 2rem; box-shadow: var(--shadow); margin-bottom: 2rem; }
  .question-meta { color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
  .question-text { font-size: 1.25rem; font-weight: 500; margin-bottom: 1.5rem; line-height: 1.6; }
  .input-group { margin-bottom: 1.5rem; }
  .input-group label { display: block; margin-bottom: 0.5rem; color: var(--muted); font-size: 0.9rem; }
  .form-input { width: 100%; padding: 1rem; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; }
  .feedback-card { background: rgba(59,130,246,0.1); border: 1px solid var(--primary); border-radius: var(--radius); padding: 1.5rem; margin-top: 1.5rem; animation: slideIn 0.3s ease-out; }
  .feedback-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
  .mark-badge { background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.9rem; }
  .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 1rem 2rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; transition: transform 0.2s; }
  .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
  .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 1rem 2rem; border-radius: var(--radius); cursor: pointer; width: 100%; margin-top: 1rem; }
  .btn-secondary:hover { background: rgba(255,255,255,0.05); }
  .warning-box { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); color: #fde047; padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem; }
  .mcq-options { display:grid; gap:0.75rem; }
  .mcq-option { display:flex; align-items:center; gap:0.75rem; cursor:pointer; }
  .mcq-option input { position:absolute; opacity:0; pointer-events:none; }
  .mcq-option span {
    flex:1; display:block; padding:0.9rem 1rem; border:1px solid var(--border);
    border-radius: var(--radius); background:#121a2b; color: var(--text); transition: all 0.15s ease;
  }
  .mcq-option:hover span { border-color: var(--primary); }
  .mcq-option input:checked + span {
    background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-color: transparent;
  }
</style>
{% endblock %}
{% block top_actions %}
<a href="{{ url_for('index') }}" style="color: var(--muted); text-decoration: none; font-size: 0.9rem;">← Back to Command Term Analyser</a>
{% endblock %}
{% block content %}
<main class="methods-container">
  <div class="question-card">
    <div class="question-meta">
      Question {{ question.id }} • {{ question.type|upper }} • {{ question.marks }} Marks
    </div>
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 0.75rem;">
      <div style="color: var(--muted); font-size: 0.9rem;">Timed Practice</div>
      <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
        <input id="timed-toggle" type="checkbox" {% if timed_on %}checked{% endif %} />
        <span style="color: var(--muted); font-size: 0.9rem;">ON/OFF</span>
      </label>
    </div>
    {% if timed_on %}
    <div id="timer" style="margin-bottom: 1rem; color:#e2e8f0;">
      ⏱ Time remaining: <strong><span id="time-left">{{ time_remaining }}</span></strong>
    </div>
    {% endif %}
    <div class="question-text">
      {{ question.text | safe }}
    </div>
    <div class="input-group" style="margin-top:0.75rem;">
      <label>Topic Selection (Coming Soon)</label>
      <select disabled style="width:100%; padding:0.5rem; border-radius:0.5rem; background:#0b1220; color:var(--muted); border:1px solid var(--border);">
        <option>— Select Topic —</option>
      </select>
    </div>

    {% if feedback %}
    <div class="feedback-card" style="border-color: {% if feedback.is_correct %}#22c55e{% else %}#eab308{% endif %}; background: {% if feedback.is_correct %}rgba(34,197,94,0.1){% else %}rgba(234,179,8,0.1){% endif %}">
      <div class="feedback-header">
                <h3 style="margin:0; color: {% if feedback.is_correct %}#4ade80{% else %}#fde047{% endif %}">
                    {% if feedback.is_correct %}Correct!{% else %}Assessment{% endif %}
                </h3>
                <span class="mark-badge" style="background: {% if feedback.is_correct %}#22c55e{% else %}#eab308{% endif %}">
                    {{ feedback.mark }} / {{ feedback.max_marks }}
                </span>
            </div>
            <p style="margin:0; line-height: 1.6;">{{ feedback.feedback }}</p>
        </div>
    {% endif %}

    {% if not feedback or not feedback.is_correct %}
    <form id="methods-form" method="POST" action="/methods-practice" style="margin-top: 2rem;">
        <input type="hidden" name="time_expired" id="time-expired" value="0" />
        {% if speed_warning %}
        <div class="warning-box">
          <strong>⚡️ Whoa there!</strong> You answered that very quickly (< 3s).<br>
          To ensure valid practice, please briefly explain your working out below.
        </div>
            <div class="input-group">
                <label>Working / Reasoning</label>
                <textarea name="working" class="form-input" rows="3" placeholder="e.g. Used chain rule..." required></textarea>
        </div>
        {% endif %}

        {% if question.type|lower == 'mcq' %}
        <div class="input-group">
          <label>Choose your answer</label>
        <div class="mcq-options">
          {% for key, val in question.options.items() %}
          <label class="mcq-option">
            <input type="radio" name="choice" value="{{ key }}" required />
            <span><strong>{{ key }}.</strong> {{ val | safe }}</span>
          </label>
          {% endfor %}
        </div>
        </div>
        {% else %}
        <div class="input-group">
          <label>Your Answer</label>
          <input type="text" name="answer" class="form-input" value="{{ user_answer or '' }}" placeholder="Enter your final answer..." required autocomplete="off">
        </div>
        {% endif %}
        
        <button type="submit" class="btn-primary">Submit Answer</button>
    </form>
    {% endif %}

    {% if feedback and (feedback.is_correct or attempts >= 3) %}
    <div style="margin-top: 2rem;">
      <a href="{{ url_for('methods_practice', action='next') }}">
        <button class="btn-primary">Next Question →</button>
      </a>
    </div>
    {% endif %}
    {% if show_try_again %}
      <div style="margin-top: 1rem;">
        <a href="{{ url_for('methods_practice', action='retry') }}"><button class="btn-secondary">Try Again</button></a>
      </div>
    {% endif %}
  </div>
</main>
{% endblock %}
{% block scripts %}
<script>
  // Timed toggle
  const timedToggle = document.getElementById('timed-toggle');
  if (timedToggle) {
    timedToggle.addEventListener('change', () => {
      const on = timedToggle.checked ? '1' : '0';
      window.location.href = '/methods-practice?action=toggle_timed&on=' + on;
    });
  }
  // Countdown timer MM:SS
  const timeLeftEl = document.getElementById('time-left');
  const formEl = document.getElementById('methods-form');
  const expiredEl = document.getElementById('time-expired');
  if (timeLeftEl && formEl && expiredEl) {
    function formatTime(totalSeconds) {
      const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const s = (totalSeconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }
    let remaining = parseInt(timeLeftEl.textContent || '0', 10);
    timeLeftEl.textContent = formatTime(remaining);
    const tick = () => {
      remaining = Math.max(0, remaining - 1);
      timeLeftEl.textContent = formatTime(remaining);
      if (remaining <= 0) {
        expiredEl.value = '1';
        formEl.submit();
      } else {
        setTimeout(tick, 1000);
      }
    };
    setTimeout(tick, 1000);
  }
  if (window.MathJax && window.MathJax.typeset) { window.MathJax.typeset(); }
</script>
{% endblock %}
