<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VCAA Command Term Explainer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <header class="site-header">
      <button id="how-to-use-btn" class="help-btn">‚ùì How to Use</button>
      <div class="header">
        <div class="brand-super">VCEInsider's</div>
        <h1 class="tool-name">DECODE</h1>
        <p class="tagline">Mastery of VCAA command terms</p>
      </div>
    </header>

    <main class="page">
      <section class="card input">
        <form id="question-form">
          <label for="question-input" class="sr-only">Question</label>
          <textarea
            id="question-input"
            placeholder="Paste your VCE question here... e.g., 'Analyse how symbolism represents societal conflict in The Crucible'"
            rows="8"
            required
          ></textarea>
          <div class="actions">
            <button id="explain-btn" type="submit">Explain Command Term</button>
          </div>
        </form>
        <div id="loading" class="loading" aria-live="polite" style="display: none;">
          <div id="loading-spinner" class="spinner" aria-hidden="true"></div>
          <span id="loading-text">Analyzing your question‚Ä¶</span>
        </div>
      </section>

      <section class="examples">
        <button class="example-btn" data-example="Evaluate the impact of economic globalization on developing nations.">Evaluate the impact of economic globalization on developing nations.</button>
        <button class="example-btn" data-example="Analyse how character development reveals themes in The Dressmaker.">Analyse how character development reveals themes in The Dressmaker.</button>
        <button class="example-btn" data-example="Discuss the role of neurotransmitters in mental health disorders.">Discuss the role of neurotransmitters in mental health disorders.</button>
      </section>

      <section id="results-card" class="card results" style="display: none;">
        <h2>Analysis</h2>
        <div id="history-indicator" class="history-indicator" style="display:none;">Loaded from history</div>
        <div class="dashboard-container">
          <div class="panel analysis-panel">
            <h3>üìò Command Term Analysis</h3>
            <div class="panel-content markdown-output" id="analysis-content"></div>
          </div>
          <div class="panel guide-panel">
            <h3>üéØ Exam Action Steps</h3>
            <div class="panel-content markdown-output" id="guide-content"></div>
          </div>
        </div>
        
        <div class="sources-container" style="margin-top: 1.5rem; text-align: left;">
            <button id="toggle-sources-btn" class="secondary-btn" style="background:none; border:none; color: #64748b; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0;">
                <span>üìö</span> View Sources
            </button>
            <div id="sources-list" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; font-size: 0.85rem; color: #475569;">
                <ul id="sources-ul" style="list-style: none; padding: 0; margin: 0;"></ul>
            </div>
        </div>
      </section>

      <section id="history-panel" class="card history collapsed" aria-label="Session History">
        <div class="history-header">
          <h2>Session History</h2>
          <div class="history-actions">
            <button id="toggle-history" type="button" class="secondary">Show History</button>
            <button id="clear-history" type="button" class="secondary">Clear History</button>
          </div>
        </div>
        <ul id="history-list" class="history-list" aria-live="polite"></ul>
      </section>
    </main>

    <footer class="site-footer">
      <p>Built by VCE graduates to help students succeed</p>
    </footer>

    <!-- How to Use Modal -->
    <div id="help-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span id="close-modal" class="close-btn">&times;</span>
        <h2>How to Use This VCE Tool</h2>
        <p class="modal-goal">Get VCAA-specific assistance with your practice questions in seconds.</p>
        <ol class="modal-steps">
            <li><strong>Paste</strong> a VCE-style exam question.</li>
            <li>Click <strong>"Analyse"</strong>.</li>
            <li>Review the <strong>Command Term Analysis</strong> (what VCAA expects).</li>
            <li>Follow the <strong>Exam Action Steps</strong> (your paragraph plan).</li>
            <li>Click <strong>"View Sources"</strong> to verify the VCAA materials used.</li>
        </ol>
        <div class="modal-note">
            <strong>Best Practice:</strong> Use this tool <em>after</em> attempting a question yourself to compare your answer with VCAA standards.
        </div>
        <p class="modal-disclaimer">Note: This tool's analysis is uniquely generated from a curated database of official VCAA exams and reports, not from generic AI knowledge.</p>
      </div>
    </div>

    <script>
      // How to Use Modal Logic
      const modal = document.getElementById("help-modal");
      const helpBtn = document.getElementById("how-to-use-btn");
      const closeBtn = document.getElementById("close-modal");

      if (helpBtn && modal && closeBtn) {
        helpBtn.onclick = function() {
          modal.style.display = "block";
        }
        closeBtn.onclick = function() {
          modal.style.display = "none";
        }
        window.onclick = function(event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }
      }

      const form = document.getElementById('question-form');
      const input = document.getElementById('question-input');
      const btn = document.getElementById('explain-btn');
      const loading = document.getElementById('loading');
      const loadingSpinner = document.getElementById('loading-spinner');
      const loadingText = document.getElementById('loading-text');
      const resultsCard = document.getElementById('results-card');
      const analysisContent = document.getElementById('analysis-content');
      const guideContent = document.getElementById('guide-content');
      const sourcesList = document.getElementById('sources-list');
      const sourcesUl = document.getElementById('sources-ul');
      const toggleSourcesBtn = document.getElementById('toggle-sources-btn');
      const historyIndicator = document.getElementById('history-indicator');
      const historyPanel = document.getElementById('history-panel');
      const historyList = document.getElementById('history-list');
      const toggleHistoryBtn = document.getElementById('toggle-history');
      const clearHistoryBtn = document.getElementById('clear-history');
      const HISTORY_KEY = 'vcaa_history';

      // Load history from localStorage
      function loadHistory() {
        try {
          const raw = localStorage.getItem(HISTORY_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }

      // Save a new entry to history (prepend, limit to 7)
      function saveHistory(question, answer) {
        const entry = { question, answer, timestamp: Date.now() };
        const history = loadHistory();
        history.unshift(entry);
        if (history.length > 7) history.length = 7;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      }

      // Format timestamp to readable HH:MM
      function formatTime(ts) {
        return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Truncate long text
      function truncate(text, n = 50) {
        if (!text) return '';
        return text.length > n ? text.slice(0, n) + '‚Ä¶' : text;
      }

      // Basic Markdown render helper
      function renderMarkdown(md) {
        return marked.parse(md || '');
      }

      function smoothScrollTo(element, duration = 800) {
        const start = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        const rect = element.getBoundingClientRect();
        const end = rect.top + start;
        const distance = end - start;
        let startTime = null;
        function easing(t) {
          return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }
        function step(currentTime) {
          if (startTime === null) startTime = currentTime;
          const timeElapsed = currentTime - startTime;
          const progress = Math.min(timeElapsed / duration, 1);
          const y = start + distance * easing(progress);
          window.scrollTo(0, y);
          if (timeElapsed < duration) {
            requestAnimationFrame(step);
          }
        }
        requestAnimationFrame(step);
      }

      toggleSourcesBtn.addEventListener('click', () => {
        const isHidden = sourcesList.style.display === 'none';
        sourcesList.style.display = isHidden ? 'block' : 'none';
        toggleSourcesBtn.innerHTML = isHidden ? '<span>üìñ</span> Hide Sources' : '<span>üìö</span> View Sources';
      });

      // Global toggle function for source text
      window.toggleSourceText = function(id, btn) {
        const preview = document.getElementById(id + '-preview');
        const full = document.getElementById(id + '-full');
        if (full.style.display === 'none') {
            full.style.display = 'inline';
            preview.style.display = 'none';
            btn.innerHTML = 'See less [-]';
        } else {
            full.style.display = 'none';
            preview.style.display = 'inline';
            btn.innerHTML = 'See more [+]';
        }
      };

      // Display results across two panels
      function displayResults(fullText, citations = []) {
        const { analysisMd, guideMd } = splitSections(fullText || '');
        analysisContent.innerHTML = renderMarkdown(analysisMd);
        guideContent.innerHTML = renderMarkdown(guideMd);
        
        // Render sources
        sourcesUl.innerHTML = '';
        if (citations && citations.length > 0) {
            citations.forEach((c, index) => {
                const li = document.createElement('li');
                li.style.marginBottom = '1rem';
                li.style.padding = '1rem';
                li.style.background = '#ffffff';
                li.style.borderRadius = '8px';
                li.style.border = '1px solid #e2e8f0';
                li.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                
                const uniqueId = `source-${index}`;
                
                li.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:0.5rem;">
                        <strong style="color:#1e293b; font-size:0.9rem;">[${c.subject || 'VCE'} ${c.year || 'Unknown'}] ${c.type || 'Exam Paper'}</strong>
                        <span style="color:#64748b; font-size:0.8rem; background:#f1f5f9; padding:2px 6px; border-radius:4px;">${Math.round(c.relevance * 100)}% Match</span>
                    </div>
                    <div style="font-size:0.9rem; color:#475569; line-height:1.6;">
                        <span id="${uniqueId}-preview">${c.snippet || ''}</span>
                        <span id="${uniqueId}-full" style="display:none;">${c.full_text || c.snippet || ''}</span>
                        <button onclick="toggleSourceText('${uniqueId}', this)" style="background:none; border:none; color:#3b82f6; cursor:pointer; font-size:0.85rem; padding:0; margin-left:0.5rem; font-weight:500;">See more [+]</button>
                    </div>
                `;
                sourcesUl.appendChild(li);
            });
            toggleSourcesBtn.style.display = 'flex';
            sourcesList.style.display = 'none'; // Collapse by default
            toggleSourcesBtn.innerHTML = '<span>üìö</span> View Sources';
        } else {
            toggleSourcesBtn.style.display = 'none';
            sourcesList.style.display = 'none';
        }

        setTimeout(() => {
          try {
            const resultsElement =
              document.getElementById('analysis-results') ||
              document.querySelector('.results-section') ||
              document.querySelector('[data-results]') ||
              resultsCard;
            if (resultsElement) {
              smoothScrollTo(resultsElement, 800);
            }
          } catch {}
        }, 100);
      }

      // Split response into analysis and guide by heading marker
      function splitSections(md) {
        const text = md || '';
        const guideMarker = /(^|\n)\s*(?:#{1,6}\s*)?(?:üéØ\s*)?Exam Action Steps\s*(\n|$)/i;
        const analysisMarker = /(^|\n)\s*(?:#{1,6}\s*)?(?:üìò\s*)?Command Term Analysis\s*(\n|$)/i;
        const legacyGuideMarker = /\n\s*###\s*Exam Action Steps\s*/i;
        const guideMatch = text.match(guideMarker);
        const analysisMatch = text.match(analysisMarker);
        if (guideMatch) {
          const idx = guideMatch.index || 0;
          const before = text.slice(0, idx);
          const after = text.slice(idx + guideMatch[0].length);
          return { analysisMd: before.trim(), guideMd: after.trim() };
        }
        if (analysisMatch) {
          const idx = analysisMatch.index || 0;
          const before = text.slice(0, idx);
          const after = text.slice(idx + analysisMatch[0].length);
          return { analysisMd: before.trim(), guideMd: after.trim() };
        }
        const legacyMatch = text.match(legacyGuideMarker);
        if (legacyMatch) {
          const idx = legacyMatch.index || 0;
          const before = text.slice(0, idx);
          const after = text.slice(idx + legacyMatch[0].length);
          return { analysisMd: before.trim(), guideMd: after.trim() };
        }
        return { analysisMd: text, guideMd: '' };
      }

      // Render history list
      function renderHistory() {
        const history = loadHistory();
        if (!history.length) {
          historyList.innerHTML = '<li class="history-empty">No history yet.</li>';
          return;
        }
        historyList.innerHTML = history
          .map((item, idx) => {
            const time = formatTime(item.timestamp);
            const preview = truncate(item.question);
            return `
              <li class="history-item" data-index="${idx}" tabindex="0" role="button" aria-label="Load history item ${idx + 1}">
                <div class="history-meta">
                  <span class="history-time">${time}</span>
                </div>
                <div class="history-text">${preview}</div>
              </li>
            `;
          })
          .join('');

        // Bind click handlers
        document.querySelectorAll('.history-item').forEach((el) => {
          el.addEventListener('click', () => {
            const index = Number(el.getAttribute('data-index'));
            const history = loadHistory();
            const item = history[index];
            if (!item) return;
            // Populate input and display analysis from history
            input.value = item.question || '';
            resultsCard.style.display = 'block';
            historyIndicator.style.display = 'inline-block';
            historyIndicator.textContent = 'Loaded from history';
            const md = item.answer || '';
            displayResults(md);
            resultsCard.classList.add('from-history');
            setTimeout(() => {
              historyIndicator.style.display = 'none';
              resultsCard.classList.remove('from-history');
            }, 1200);
            resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
          // Keyboard accessibility
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') el.click();
          });
        });
      }

      // Toggle history panel visibility
      function toggleHistory() {
        const collapsed = historyPanel.classList.toggle('collapsed');
        toggleHistoryBtn.textContent = collapsed ? 'Show History' : 'Hide History';
      }
      toggleHistoryBtn.addEventListener('click', toggleHistory);

      // Clear history
      clearHistoryBtn.addEventListener('click', () => {
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
      });

      // Initial render on page load
      renderHistory();
      // Keep panel collapsed by default on small screens
      toggleHistoryBtn.textContent = 'Show History';

      document.querySelectorAll('.example-btn').forEach((el) => {
        el.addEventListener('click', () => {
          input.value = el.dataset.example || '';
          input.focus();
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = input.value.trim();
        if (!question) return;

        btn.disabled = true;
        loading.style.display = 'flex';
        loadingSpinner.style.display = 'block';
        loadingText.innerText = 'Analyzing your question...';
        resultsCard.style.display = 'none';
        analysisContent.innerHTML = '';
        guideContent.innerHTML = '';

        try {
          const resp = await fetch('/explain', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question }),
          });

          const data = await resp.json();
          if (!resp.ok) {
            loadingSpinner.style.display = 'none';
            loadingText.innerText = 'Analysis failed.';
            analysisContent.textContent = data.error || 'Something went wrong.';
            guideContent.innerHTML = '';
            resultsCard.style.display = 'block';
            setTimeout(() => { loading.style.display = 'none'; }, 1500);
          } else {
            loadingSpinner.style.display = 'none';
            loadingText.innerHTML = '‚úÖ Completed!';
            const md = data.analysis || '';
            const citations = data.citations || [];
            displayResults(md, citations);
            resultsCard.style.display = 'block';
            setTimeout(() => { loading.style.display = 'none'; }, 1000);
            // Save to history on success
            saveHistory(question, md);
            renderHistory();
          }
        } catch (err) {
          loadingSpinner.style.display = 'none';
          loadingText.innerText = 'Analysis failed.';
          analysisContent.textContent = 'Network error. Please try again.';
          guideContent.innerHTML = '';
          resultsCard.style.display = 'block';
          setTimeout(() => { loading.style.display = 'none'; }, 1500);
        } finally {
          btn.disabled = false;
        }
      });
    </script>
    <button
      data-feedback-fish
      style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #3B82F6;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
      "
      onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';"
    >
      üí¨ Feedback
    </button>
    <script defer src="https://feedback.fish/ff.js?pid=cf597e1334a38a"></script>
  </body>
</html>
